name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Node.js dependencies
        run: pnpm install

      - name: Build Tauri application
        run: pnpm tauri build

      - name: Create ZIP archive
        id: archive
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          $zipName = "valo-accounts-${version}-windows.zip"
          $exeName = "valo-accounts-${version}-windows.exe"
          Compress-Archive -Path "src-tauri\target\release\valo-accounts.exe" -DestinationPath $zipName
          Copy-Item "src-tauri\target\release\valo-accounts.exe" -Destination $exeName
          "zip_name=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "exe_name=$exeName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Generate release notes
        shell: pwsh
        run: |
          $currentTag = "${{ github.ref_name }}"

          $prevTag = git tag --sort=-version:refname |
            Where-Object { $_ -ne $currentTag } |
            Select-Object -First 1

          if ($prevTag) {
            $commitOutput = git log --pretty=format:"%s" "${prevTag}..HEAD" 2>&1
          } else {
            $commitOutput = git log --pretty=format:"%s" 2>&1
          }

          $commits = if ($commitOutput) {
            ($commitOutput -split "`n") | Where-Object { $_ -ne "" }
          } else {
            @()
          }

          $features = [System.Collections.Generic.List[string]]::new()
          $fixes    = [System.Collections.Generic.List[string]]::new()
          $perfs    = [System.Collections.Generic.List[string]]::new()
          $others   = [System.Collections.Generic.List[string]]::new()

          foreach ($commit in $commits) {
            if ($commit -match '^feat(\(.+\))?!?:\s*(.+)$') {
              $features.Add("- $($Matches[2])")
            } elseif ($commit -match '^fix(\(.+\))?!?:\s*(.+)$') {
              $fixes.Add("- $($Matches[2])")
            } elseif ($commit -match '^perf(\(.+\))?!?:\s*(.+)$') {
              $perfs.Add("- $($Matches[2])")
            } elseif ($commit -match '^(refactor|docs|chore|revert)(\(.+\))?!?:\s*(.+)$') {
              $others.Add("- $($Matches[3])")
            }
            # exclude test, ci, build, style
          }

          $lines = [System.Collections.Generic.List[string]]::new()

          if ($features.Count -gt 0) {
            $lines.Add("## New Features")
            $lines.Add("")
            $lines.AddRange($features)
            $lines.Add("")
          }
          if ($fixes.Count -gt 0) {
            $lines.Add("## Bug Fixes")
            $lines.Add("")
            $lines.AddRange($fixes)
            $lines.Add("")
          }
          if ($perfs.Count -gt 0) {
            $lines.Add("## Performance Improvements")
            $lines.Add("")
            $lines.AddRange($perfs)
            $lines.Add("")
          }
          if ($others.Count -gt 0) {
            $lines.Add("## Other Changes")
            $lines.Add("")
            $lines.AddRange($others)
            $lines.Add("")
          }

          if ($lines.Count -eq 0) {
            $lines.Add("No notable changes. Please refer to the commit log for details.")
          }

          $lines -join "`n" | Out-File -FilePath "release_notes.md" -Encoding utf8

      - name: Create draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: |
            ${{ steps.archive.outputs.zip_name }}
            ${{ steps.archive.outputs.exe_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
